ALTER SESSION SET CURRENT_SCHEMA=APPS;





SELECT ASL.LOAN_TOTAL_AMOUNT,
       ASL.LOAN_AMOUNT,
       ASL.LOAN_INTEREST_AMOUNT,
       ASL.LOAN_INTEREST_RATE,
       ASL.LOAN_BALANCE,
       ASL.ATTRIBUTE1
  FROM ATET_SB_MEMBERS          ASM,
       ATET_SB_LOANS            ASL
 WHERE 1 = 1
   AND ASM.SAVING_BANK_ID = 2
   AND ASM.MEMBER_ID = ASL.MEMBER_ID;
   
   
--UPDATE ATET_SB_LOANS    ASL
--   SET ASL.LOAN_TOTAL_AMOUNT = TRUNC(ASL.LOAN_TOTAL_AMOUNT, 2),
--       ASL.LOAN_AMOUNT = TRUNC(ASL.LOAN_AMOUNT, 2),
--       ASL.LOAN_INTEREST_AMOUNT = TRUNC(ASL.LOAN_INTEREST_AMOUNT,2),
--       ASL.LOAN_INTEREST_RATE = TRUNC(ASL.LOAN_INTEREST_RATE,2),
--       ASL.LOAN_BALANCE = TRUNC(ASL.LOAN_BALANCE,2),
--       ASL.ATTRIBUTE1 = TRUNC(ASL.ATTRIBUTE1,2);
--       
--       
--COMMIT;



SELECT ASM.MEMBER_ID,
       ASM.PERSON_ID,
       ASM.EMPLOYEE_NUMBER,
       ASM.EMPLOYEE_FULL_NAME,
       ASL.LOAN_ID,
       ASL.LOAN_NUMBER,
       ASL.LOAN_BALANCE,
       ASMA.FINAL_BALANCE,
       ASMA.DEBIT_BALANCE,
       ASMA.CREDIT_BALANCE
  FROM ATET_SB_MEMBERS                  ASM,
       ATET_SB_LOANS                    ASL,
       ATET_SB_MEMBERS_ACCOUNTS         ASMA
 WHERE 1 = 1
   AND ASM.SAVING_BANK_ID = 2
   AND ASM.MEMBER_ID = ASL.MEMBER_ID
   AND ASMA.MEMBER_ID = ASM.MEMBER_ID
   AND ASMA.LOAN_ID = ASL.LOAN_ID;
   
   
--UPDATE ATET_SB_MEMBERS_ACCOUNTS ASMA
--   SET DEBIT_BALANCE = TRUNC(DEBIT_BALANCE, 2),
--       CREDIT_BALANCE = TRUNC(CREDIT_BALANCE, 2);
--       
--COMMIT;


--UPDATE ATET_SB_MEMBERS_ACCOUNTS ASMA
--   SET FINAL_BALANCE = DEBIT_BALANCE - CREDIT_BALANCE;
--   
--   
--COMMIT;

/*******************************************************/
/*********  DIFERENCIA SALDO MEMBERS_ACCOUNTS***********/
/*******************************************************/
SELECT *
  FROM (
  
        SELECT ASM.MEMBER_ID,
               ASM.PERSON_ID,
               ASM.EMPLOYEE_NUMBER,
               ASM.EMPLOYEE_FULL_NAME,
               ASL.LOAN_ID,
               ASL.LOAN_NUMBER,
               ASL.LOAN_BALANCE,
               ASMA.FINAL_BALANCE
          FROM ATET_SB_MEMBERS                  ASM,
               ATET_SB_LOANS                    ASL,
               ATET_SB_MEMBERS_ACCOUNTS         ASMA
         WHERE 1 = 1
           AND ASM.SAVING_BANK_ID = 2
           AND ASM.MEMBER_ID = ASL.MEMBER_ID
           AND ASMA.MEMBER_ID = ASM.MEMBER_ID
           AND ASMA.LOAN_ID = ASL.LOAN_ID
       
       ) DET
 WHERE 1 = 1
   AND DET.LOAN_BALANCE <> FINAL_BALANCE;
   
   
   
   
   
   
   
SELECT ASPS.OPENING_BALANCE,
       ASPS.PAYMENT_AMOUNT,
       ASPS.PAYMENT_CAPITAL,
       ASPS.PAYMENT_INTEREST,
       ASPS.PAYMENT_INTEREST_LATE,
       ASPS.PAYED_AMOUNT,
       ASPS.PAYED_CAPITAL,
       ASPS.PAYED_INTEREST,
       ASPS.PAYED_INTEREST_LATE,
       ASPS.OWED_AMOUNT,
       ASPS.OWED_CAPITAL,
       ASPS.OWED_INTEREST,
       ASPS.OWED_INTEREST_LATE,
       ASPS.FINAL_BALANCE,
       ASPS.ACCRUAL_PAYMENT_AMOUNT
  FROM ATET_SB_PAYMENTS_SCHEDULE    ASPS
 WHERE 1 = 1;
 
 
 
 
--UPDATE ATET_SB_PAYMENTS_SCHEDULE    ASPS
--   SET ASPS.OPENING_BALANCE = TRUNC(ASPS.OPENING_BALANCE,2),
--       ASPS.PAYMENT_AMOUNT = TRUNC(ASPS.PAYMENT_AMOUNT,2),
--       ASPS.PAYMENT_CAPITAL = TRUNC(ASPS.PAYMENT_CAPITAL,2),
--       ASPS.PAYMENT_INTEREST = TRUNC(ASPS.PAYMENT_INTEREST,2),
--       ASPS.PAYMENT_INTEREST_LATE = TRUNC(ASPS.PAYMENT_INTEREST_LATE,2),
--       ASPS.PAYED_AMOUNT = TRUNC(ASPS.PAYED_AMOUNT,2),
--       ASPS.PAYED_CAPITAL = TRUNC(ASPS.PAYED_CAPITAL,2),
--       ASPS.PAYED_INTEREST = TRUNC(ASPS.PAYED_INTEREST,2),
--       ASPS.PAYED_INTEREST_LATE = TRUNC(ASPS.PAYED_INTEREST_LATE,2),
--       ASPS.OWED_AMOUNT = TRUNC(ASPS.OWED_AMOUNT,2),
--       ASPS.OWED_CAPITAL = TRUNC(ASPS.OWED_CAPITAL,2),
--       ASPS.OWED_INTEREST = TRUNC(ASPS.OWED_INTEREST,2),
--       ASPS.OWED_INTEREST_LATE = TRUNC(ASPS.OWED_INTEREST_LATE,2),
--       ASPS.FINAL_BALANCE = TRUNC(ASPS.FINAL_BALANCE,2),
--       ASPS.ACCRUAL_PAYMENT_AMOUNT = TRUNC(ASPS.ACCRUAL_PAYMENT_AMOUNT,2);
--       
--COMMIT;
 

SELECT ASLT.ENTRY_VALUE,
       ASLT.DEBIT_AMOUNT,
       ASLT.CREDIT_AMOUNT,
       ASLT.PAYMENT_AMOUNT,
       ASLT.PAYMENT_CAPITAL,
       ASLT.PAYMENT_INTEREST,
       ASLT.PAYMENT_INTEREST_LATE
  FROM ATET_SB_LOANS_TRANSACTIONS   ASLT;
  
  
--UPDATE ATET_SB_LOANS_TRANSACTIONS   ASLT
--   SET ASLT.ENTRY_VALUE = TRUNC(ASLT.ENTRY_VALUE,2),
--       ASLT.DEBIT_AMOUNT = TRUNC(ASLT.DEBIT_AMOUNT,2),
--       ASLT.CREDIT_AMOUNT = TRUNC(ASLT.CREDIT_AMOUNT,2),
--       ASLT.PAYMENT_AMOUNT = TRUNC(ASLT.PAYMENT_AMOUNT,2),
--       ASLT.PAYMENT_CAPITAL = TRUNC(ASLT.PAYMENT_CAPITAL,2),
--       ASLT.PAYMENT_INTEREST = TRUNC(ASLT.PAYMENT_INTEREST,2),
--       ASLT.PAYMENT_INTEREST_LATE = TRUNC(ASLT.PAYMENT_INTEREST_LATE,2);
--       
--       
--COMMIT;


SELECT *
  FROM ATET_SB_MEMBERS          ASM,
       ATET_SB_MEMBERS_ACCOUNTS ASMA
 WHERE 1 = 1 
   AND ASM.SAVING_BANK_ID = 2
   AND ASM.MEMBER_ID = ASMA.MEMBER_ID
   AND ASMA.LOAN_ID IS NULL;


--UPDATE ATET_SB_MEMBERS_ACCOUNTS ASMA
--   SET ASMA.FINAL_BALANCE = ASMA.CREDIT_BALANCE - ASMA.DEBIT_BALANCE
-- WHERE 1 = 1
--   AND LOAN_ID IS NULL
--   AND ACCOUNT_DESCRIPTION = 'D071_CAJA DE AHORRO';   

--COMMIT;


SELECT ASST.ENTRY_VALUE,
       ASST.DEBIT_AMOUNT,
       ASST.CREDIT_AMOUNT
  FROM ATET_SB_SAVINGS_TRANSACTIONS     ASST
 WHERE 1 = 1;


--UPDATE ATET_SB_SAVINGS_TRANSACTIONS     ASST
--   SET ASST.ENTRY_VALUE = TRUNC(ASST.ENTRY_VALUE,2),
--       ASST.DEBIT_AMOUNT = TRUNC(ASST.DEBIT_AMOUNT,2),
--       ASST.CREDIT_AMOUNT = TRUNC(ASST.CREDIT_AMOUNT,2);
--       
--COMMIT;



/***********************************************************************/
/*          CONSULTA DE DIFERECNIA DE CENTAVOS EN       AHORRO         */
/***********************************************************************/
SELECT *
  FROM (
      
        SELECT ASM.MEMBER_ID,
               ASM.PERSON_ID,
               ASM.EMPLOYEE_NUMBER,
               ASM.EMPLOYEE_FULL_NAME,
               ASMA.FINAL_BALANCE,
               SUM(ASST.CREDIT_AMOUNT) - SUM(ASST.DEBIT_AMOUNT) AS ASST_BALANCE
          FROM ATET_SB_MEMBERS                  ASM,
               ATET_SB_SAVINGS_TRANSACTIONS     ASST,
               ATET_SB_MEMBERS_ACCOUNTS         ASMA
         WHERE 1 = 1
           AND ASM.SAVING_BANK_ID = 2
           AND ASM.MEMBER_ID = ASST.MEMBER_ID
           AND ASST.MEMBER_ACCOUNT_ID = ASMA.MEMBER_ACCOUNT_ID
           AND ASMA.MEMBER_ID = ASM.MEMBER_ID
           AND ASMA.ACCOUNT_DESCRIPTION = 'D071_CAJA DE AHORRO'
         GROUP 
            BY ASM.MEMBER_ID,
               ASM.PERSON_ID,
               ASM.EMPLOYEE_NUMBER,
               ASM.EMPLOYEE_FULL_NAME,
               ASMA.FINAL_BALANCE
               
       )
 WHERE 1 = 1
   AND FINAL_BALANCE <> ASST_BALANCE;


--DECLARE
--    
--CURSOR  DETAILS
--IS
--SELECT *
--  FROM (

--        SELECT ASM.MEMBER_ID,
--               ASM.PERSON_ID,
--               ASL.LOAN_ID,
--               ASM.EMPLOYEE_NUMBER,
--               ASM.EMPLOYEE_FULL_NAME,
--               ASMA.CREDIT_BALANCE,
--               SUM(ASLT.CREDIT_AMOUNT) - SUM(ASLT.PAYMENT_INTEREST_LATE)  ASLT_BALANCE
--          FROM ATET_SB_MEMBERS              ASM,
--               ATET_SB_LOANS                ASL,
--               ATET_SB_MEMBERS_ACCOUNTS     ASMA,
--               ATET_SB_LOANS_TRANSACTIONS   ASLT
--         WHERE 1 = 1
--           AND ASM.SAVING_BANK_ID = 2
--           AND ASL.MEMBER_ID = ASM.MEMBER_ID
--           AND ASMA.LOAN_ID = ASL.LOAN_ID
--           AND ASMA.MEMBER_ID = ASM.MEMBER_ID
--           AND ASLT.MEMBER_ID = ASM.MEMBER_ID
--           AND ASLT.LOAN_ID = ASL.LOAN_ID
--           AND ASLT.MEMBER_ACCOUNT_ID = ASMA.MEMBER_ACCOUNT_ID
--         GROUP 
--            BY ASM.MEMBER_ID,
--               ASM.PERSON_ID,
--               ASL.LOAN_ID,
--               ASM.EMPLOYEE_NUMBER,
--               ASM.EMPLOYEE_FULL_NAME,
--               ASMA.CREDIT_BALANCE
--       )
-- WHERE 1 = 1
--   AND CREDIT_BALANCE <> ASLT_BALANCE
--   ;

--BEGIN

--    FOR DETAIL IN DETAILS LOOP
--    
--        UPDATE ATET_SB_MEMBERS_ACCOUNTS ASMA
--           SET ASMA.CREDIT_BALANCE = DETAIL.ASLT_BALANCE
--         WHERE 1 = 1
--           AND ASMA.LOAN_ID = DETAIL.LOAN_ID
--           AND ASMA.MEMBER_ID = DETAIL.MEMBER_ID;
--    
--    END LOOP;

--END;

--COMMIT;

SELECT *
  FROM (

        SELECT ASM.MEMBER_ID,
               ASM.PERSON_ID,
               ASL.LOAN_ID,
               ASM.EMPLOYEE_NUMBER,
               ASM.EMPLOYEE_FULL_NAME,
               ASMA.CREDIT_BALANCE,
               SUM(ASLT.CREDIT_AMOUNT) - SUM(ASLT.PAYMENT_INTEREST_LATE)  ASLT_BALANCE
          FROM ATET_SB_MEMBERS              ASM,
               ATET_SB_LOANS                ASL,
               ATET_SB_MEMBERS_ACCOUNTS     ASMA,
               ATET_SB_LOANS_TRANSACTIONS   ASLT
         WHERE 1 = 1
           AND ASM.SAVING_BANK_ID = 2
           AND ASL.MEMBER_ID = ASM.MEMBER_ID
           AND ASMA.LOAN_ID = ASL.LOAN_ID
           AND ASMA.MEMBER_ID = ASM.MEMBER_ID
           AND ASLT.MEMBER_ID = ASM.MEMBER_ID
           AND ASLT.LOAN_ID = ASL.LOAN_ID
           AND ASLT.MEMBER_ACCOUNT_ID = ASMA.MEMBER_ACCOUNT_ID
         GROUP 
            BY ASM.MEMBER_ID,
               ASM.PERSON_ID,
               ASL.LOAN_ID,
               ASM.EMPLOYEE_NUMBER,
               ASM.EMPLOYEE_FULL_NAME,
               ASMA.CREDIT_BALANCE
       )
 WHERE 1 = 1
   AND CREDIT_BALANCE <> ASLT_BALANCE
   ;

UPDATE ATET_SB_MEMBERS_ACCOUNTS ASMA
   SET FINAL_BALANCE = DEBIT_BALANCE - CREDIT_BALANCE
 WHERE 1 = 1
   AND ASMA.LOAN_ID IS NOT NULL
   AND ASMA.ACCOUNT_DESCRIPTION = 'D072_PRESTAMO CAJA DE AHORRO';


 
/***********************************************************************/
/*          CONSULTA DE DIFERECNIA DE CENTAVOS EN       PRESTAMOS         */
/***********************************************************************/
SELECT *
  FROM (
        SELECT *
          FROM (
          
                SELECT ASM.MEMBER_ID,
                       ASM.PERSON_ID,
                       ASM.EMPLOYEE_NUMBER,
                       ASM.EMPLOYEE_FULL_NAME,
                       ASL.LOAN_ID,
                       ASL.LOAN_NUMBER,
                       ASL.LOAN_TOTAL_AMOUNT,
                       ASL.LOAN_BALANCE,
                       ASMA.FINAL_BALANCE,
                       SUM(NVL(ASPS.OWED_CAPITAL, ASPS.PAYMENT_CAPITAL) +
                           NVL(ASPS.OWED_INTEREST, ASPS.PAYMENT_INTEREST) ) ASPS_PAYMENT_BALANCE
                  FROM ATET_SB_MEMBERS                  ASM,
                       ATET_SB_LOANS                    ASL,
                       ATET_SB_MEMBERS_ACCOUNTS         ASMA,
                       ATET_SB_PAYMENTS_SCHEDULE        ASPS
                 WHERE 1 = 1
                   AND ASM.SAVING_BANK_ID = 2
                   AND ASM.MEMBER_ID = ASL.MEMBER_ID
                   AND ASMA.MEMBER_ID = ASM.MEMBER_ID
                   AND ASMA.LOAN_ID = ASL.LOAN_ID
                   AND ASPS.LOAN_ID = ASL.LOAN_ID
                   AND ASPS.STATUS_FLAG IN ('SKIP',
                                            'PARTIAL',
                                            'PENDING',
                                            'EXPORTED')
                 GROUP 
                    BY ASM.MEMBER_ID,
                       ASM.PERSON_ID,
                       ASM.EMPLOYEE_NUMBER,
                       ASM.EMPLOYEE_FULL_NAME,
                       ASL.LOAN_ID,
                       ASL.LOAN_NUMBER,
                       ASL.LOAN_BALANCE,
                       ASMA.FINAL_BALANCE,
                       ASL.LOAN_TOTAL_AMOUNT
               
               ) DET
         WHERE 1 = 1
           AND (   
                   DET.LOAN_BALANCE <> DET.FINAL_BALANCE
                OR DET.LOAN_BALANCE <> DET.ASPS_PAYMENT_BALANCE
                OR DET.FINAL_BALANCE <> DET.ASPS_PAYMENT_BALANCE)
       )DET2
 WHERE 1 = 1
             
    ;
        
        
