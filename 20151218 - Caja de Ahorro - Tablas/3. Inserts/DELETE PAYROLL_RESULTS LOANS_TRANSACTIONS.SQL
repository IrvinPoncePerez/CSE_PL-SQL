DELETE FROM ATET_SB_LOANS_TRANSACTIONS ASLT
 WHERE 1 = 1
   AND ASLT.PERIOD_NAME <> 'APERTURA';
   
--SELECT *
--  FROM ATET_SB_LOANS_TRANSACTIONS;
   
DELETE FROM ATET_SB_SAVINGS_TRANSACTIONS;
DELETE FROM ATET_SB_PAYROLL_RESULTS;
DELETE FROM ATET_SB_PAYMENTS_SCHEDULE
WHERE ATTRIBUTE5 IS NOT NULL;

--COMMIT;

UPDATE ATET_SB_LOANS
   SET LOAN_BALANCE = LOAN_TOTAL_AMOUNT,
       LAST_PAYMENT_DATE = NULL;
   
--COMMIT;

UPDATE ATET_SB_PAYMENTS_SCHEDULE
   SET STATUS_FLAG = 'PENDING',
       PAYED_AMOUNT = NULL,
       PAYED_CAPITAL = NULL,
       PAYED_INTEREST = NULL,
       PAYED_INTEREST_LATE = NULL,
       OWED_AMOUNT = NULL,
       OWED_CAPITAL = NULL,
       OWED_INTEREST = NULL,
       OWED_INTEREST_LATE = NULL;
       
--COMMIT;


UPDATE ATET_SB_MEMBERS_ACCOUNTS
   SET FINAL_BALANCE = DEBIT_BALANCE,
       CREDIT_BALANCE = 0,
       LAST_TRANSACTION_DATE = NULL;
       
--COMMIT;

SELECT *
  FROM (SELECT ASL.LOAN_ID,
               ASL.LOAN_NUMBER,
               ASL.TERM_PERIODS,
               COUNT(ASPS.PAYMENT_SCHEDULE_ID) PAYMENTS_SCHEDULE
          FROM ATET_SB_LOANS                ASL,
               ATET_SB_PAYMENTS_SCHEDULE    ASPS
         WHERE 1 = 1
           AND ASL.LOAN_ID = ASPS.LOAN_ID
         GROUP BY ASL.LOAN_ID,
                  ASL.LOAN_NUMBER,
                  ASL.TERM_PERIODS) D
 WHERE 1 = 1
   AND D.TERM_PERIODS = D.PAYMENTS_SCHEDULE
